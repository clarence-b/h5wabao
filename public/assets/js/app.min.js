!function(){var e={localStor:window.localStorage,GuID:window.localStorage.getItem("GuID"),elemLoad:$("#loading"),page1:$("#page1"),page2:$("#page2"),homeBox:$("#page1 .box"),homeTitle:$("#page1 .title"),btnGo:$("#go"),btnStart:$("#start"),fieldsCol:$(".fields .col"),disX:0,disY:0,pageX:0,pageY:0,elemPrize:$("#prize"),elemOppor:$("#oppor"),elemLogLink:$("#logLink"),elemBtnAccept:$("#btnAccept"),elemBtnClose:$("#btnClose"),elemBtnOK:$("#btnOk"),init:function(){this.guid(),this.imgInit(),this.goto(),this.start(),this.showAccept()},imgInit:function(){var e=this,t=$("#page1 img").eq(0),i=$("#page2 img").eq(0),a=$("#pathimg");t.attr("src",t.data("src")),i.attr("src",i.data("src")),a.attr("src",a.data("src"));var n=setTimeout(function(){e.elemLoad.hide(),e.homeTitle.addClass("fadeInLeft delay500"),e.homeBox.addClass("tada delay1200"),clearTimeout(n)},1e3)},newGuid:function(){var e=this;$.get("index.php?r=main/api/apiCteateNewUser",{},function(t){e.localStor.setItem("GuID",t),e.elemOppor.text(3),e.GuID=e.localStor.getItem("GuID"),console.log("NEW GUID: "+t)})},guid:function(){var e=this;e.GuID?($.get("index.php?r=main/api/apiGetUserByGuID",{guid:e.GuID},function(t){if(t.code>0){var i=$.parseJSON(t.data);e.elemOppor.text(i.oppor)}else e.newGuid()},"JSON"),console.log("GUID: "+e.GuID)):e.newGuid()},"goto":function(){var e=this;e.btnGo.on("click",function(){e.page1.hide(),e.page2.fadeIn("slow")})},start:function(){var t=this,i=!0;t.fieldsCol.on("click",function(){i&&($(".wrap span").hide(),pageX=event.pageX,pageY=event.pageY,disX=pageX-$(this).offset().left,disY=pageY-$(this).offset().top,e.getPrize(),i=!1);var t=setTimeout(function(){i=!0,clearTimeout(t)},5e3)})},startScoop:function(e){var t=this;t.btnStart.fadeIn().css({left:pageX-disX,top:pageY-disY-20}),setTimeout(function(){$(".scoop").fadeIn(300)},500),setTimeout(function(){$(".tu").fadeIn(300)},1e3),setTimeout(function(){$(".box").fadeIn(300),$(".scoop").fadeOut(300)},2e3),e&&setTimeout(e,3500)},notScoop:function(e){var t=this;t.btnStart.fadeIn().css({left:pageX-disX,top:pageY-disY-20}),setTimeout(function(){$(".scoop").fadeIn(300)},500),setTimeout(function(){$(".tu").fadeIn(300)},1e3),e&&setTimeout(e,2e3)},getPrize:function(){var e=this,t=parseInt(e.elemOppor.text());0==t?e.dialogMsg("您没有抽奖机会了!"):t>0&&$.post("index.php?r=main/api/apiGetSeckill",{guid:e.GuID},function(t){if(console.log(t),-1==t.code)e.notScoop(function(){e.dialogMsg(t.message)});else{var i=$.parseJSON(t.data);t.code?(e.startScoop(function(){e.elemPrize.attr("src",baseUrl+"assets/images/prize_0"+i.prize_id+".png").fadeIn("slow"),$("#prize_state").show()}),e.startScoop(function(){e.dialogForm()})):e.notScoop(function(){e.dialogMsg(t.message)}),e.elemOppor.text(parseInt(e.elemOppor.text())-1)}},"JSON")},dialogMsg:function(e){var t='<div class="dialogMsg">                <span>{{msg}}</span>            </div>';$("body").append(t.replace(/{{msg}}/,e)),setTimeout(function(){$(".dialogMsg").remove()},3e3)},dialogForm:function(){var t='<div id="bindUser" class="bindWrap">                            <div class="bindWrap-title">提交用户信息</div>                            <div class="bindWrap-content">                                <input type="text" placeholder="姓名" name="username" id="username">                                <input type="tel" placeholder="电话" name="telephone" id="telephone">                            </div>                            <button type="button" class="bindWrap-btn" id="subUser">提交信息</button>                        </div>';$("body").append(t),$("#subUser").on("click",function(){var t=$("#username").val(),i=$("#telephone").val();if(t.length>0&&i.length>0){var a=/^[\u4E00-\u9FA5]{2,4}$/,n=/^0?1[3|4|5|7|8][0-9]\d{8}$/;if(!a.test(t))return e.dialogMsg("用户名必须2-4位汉字!"),!1;if(!n.test(i))return e.dialogMsg("手机号码格式不正确!"),!1;$.ajax({url:"index.php?r=main/api/apiOnSubmit",type:"POST",dataType:"json",data:{guid:e.GuID,username:t,telephone:i}}).done(function(t){t?(e.dialogMsg("提交成功!"),$("#bindUser").remove()):e.dialogMsg("失败!!!")}).fail(function(){e.dialogMsg("submit error!")})}else e.dialogMsg("请填写用户信息!")})},showAccept:function(){var t=this,i=$(".acceptWrap");t.elemLogLink.on("click",function(){$.getJSON("index.php?r=main/api/apiViewUserByPrizes",{guid:e.GuID},function(e){if(e.code){var t=$.parseJSON(e.data);$("#prize_name").html(t.prize_name),1==parseInt(t.accept)?($("#prize_state > #btnAccept").hide(),$("#prize_state > .accept").show()):($("#prize_state > #btnAccept").show(),$("#prize_state > .accept").hide())}else $("#prize_state").hide()}),$("#page2").fadeOut(300,function(){$("#page3").fadeIn(300)})}),t.elemBtnAccept.on("click",function(){$.get("index.php?r=main/api/apiGetSubmitStatus",{guid:e.GuID},function(e){0==e?t.dialogForm():i.fadeIn(300)})}),t.elemBtnClose.on("click",function(){$("#page3").fadeOut(300,function(){$("#page2").fadeIn(300)})}),t.elemBtnOK.on("click",function(){var t=$("#code").val();t.length>0&&$.post("index.php?r=main/api/apiUpdateUserByAccept",{guid:e.GuID,code:t},function(t){t.code&&(i.hide(),$("#prize_state").html('<span class="accept">已领奖</span>')),e.dialogMsg(t.message)},"json")})}};window.onload=function(){e.init()}}();